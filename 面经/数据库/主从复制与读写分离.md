# MySQL主从复制

**mysql支持的复制类型：**

* STATEMENT：基于语句的复制。在服务器上执行sql语句，在从服务器上执行同样的语句，mysql默 认采用基于语句的复制，执行效率高。

* ROW：基于行的复制。把改变的内容复制过去，而不是把命令在从服务器上执行一遍。

* MIXED：混合类型的复制。默认采用基于语句的复制，一 旦发现基于语句无法精确复制时，就会采用基于行的复制。

**主从复制的基本过程如下:**

1. 主数据库（Master）将用户对数据库更新的操作以二进制格式保存到BinaryLog日志文件中；

2. 从数据库（Slave）每隔一定的时间间隔或SQL语句，会对Master的二进制日志进行探测其是否发生改变，如果发生改变，则开始一个I/O线程请求主数据库的新增的日志内容；

3. Master接收到来自Slave的I/O进程的请求后，通过负责复制的I/O进程根据请求信息读取二进制日志指定位置之后的日志信息，返回给Slave的I/O进程。返回信息中除了日志所包含的信息之外，还包括本次返回的信息已经到Master端的bin-log文件的名称以及bin-log的位置；

4. 主数据库在接收到请求后会为每个I/O线程启动一个dump线程，用于向其发送日志文件，并保存到从数据库本地的中继日志（Relaylog）中；

5. 从数据库就会启动一个SQL线程重做中继日志中的日志，即将二进制日志解析成SQL语句逐一执行，保持主从数据库数据的同步。

# MySQL读写分离

**什么是读写分离？**

简单来说，读写分离就是只在主服务器上写，只在从服务器上读。

读写分离基本的原理是让主数据库处理事务性增、改、删操作（INSERT、UPDATE、DELETE），而从数据库处理SELECT查询操作。数据库复制被用来把事务性操作导致的变更同步到集群中的从数据库。

**为什么要读写分离？** 

因为数据库的“写”（写10000条数据可能要3分钟）操作是比较耗时的。 但是数据库的“读”（读10000条数据可能只要5秒钟）操作相对比较快。 所以读写分离，解决的是，数据库的写入，影响了查询的效率。

**什么情况下要读写分离？**

数据库不一定要读写分离，如果程序使用数据库较多时，而更新少，查询多的情况下会考虑使用。利用数据库主从同步，再通过读写分离可以分担数据库压力，提高性能。

**Mysql主从复制有几种同步模式？**

* 异步复制（Asynchronous replication）
    MySQL默认的复制即是异步的，主库在执行完客户端提交的事务后会立即将结果返给客户端，并不关心从库是否已经接收并处理，这样就会有一个问题，主如果crash掉了，此时主上已经提交的事务可能并没有传到从上，如果此时，强行将从提升为主，可能导致新主上的数据不完整。

* 全同步复制（Fully synchronous replication）
    指当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端。因为需要等待所有从库执行完该事务才能返回，所以全同步复制的性能必然会收到严重的影响。

* 半同步复制（Semisynchronous replication）
    介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到relay log中才返回给客户端。相对于异步复制，半同步复制提高了数据的安全性，同时它也造成了一定程度的延迟，这个延迟最少是一个TCP/IP往返的时间。所以，半同步复制最好在低延时的网络中使用。

**常见的MySQL读写分离有哪些？**

（1）基于程序代码内部实现

在代码中根据 select、insert 进行路由分类，这类方法也是目前生产环境应用最广泛的。

优点是性能较好，因为在程序代码中实现，不需要增加额外的设备为硬件开支；
缺点是需要开发人员来实现，运维人员无从下手。不是所有的应用都适合在程序代码中实现读写分离，像一些大型复杂的Java应用，如果在程序代码中实现读写分离对代码改动就较大。

（2）基于中间代理层实现

代理一般位于客户端和服务器之间，代理服务器接到客户端请求后通过判断后转发到后端数据库，有以下代表性程序：

* MySQL-Proxy：MySQL-Proxy 为 MySQL 开源项目，通过其自带的lua脚本进行SQL判断。

* Atlas：是由奇虎360的Web平台部基础架构团队开发维护的一个基于MySQL协议的数据中间层项目。它是在mysql-proxy 0.8.2版本的基础上，对其进行了优化，增加了一些新的功能特性。360内部使用Atlas运行的mysql业务，每天承载的读写请求数达几十亿条。支持事物以及存储过程。

* Amoeba：由陈思儒开发，作者曾就职于阿里巴巴。该程序由Java语言进行开发，阿里巴巴将其用于生产环境。但是它不支持事务和存储过程。

由于使用MySQL Proxy需要写大量的Lua脚本，这些Lua脚本不是现成的，而需要自己编写，这对于并不熟悉MySQL Proxy内置变量和MySQL Protocol的人来说是非常困难的。

Amoeba是一个非常容易使用，可移植性非常强的软件，因此它在生产环境中被广泛用于数据库的代理层。