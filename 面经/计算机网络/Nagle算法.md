# Nagle算法

在网络拥塞控制领域，有一个非常有名的算法叫做Nagle算法（Nagle algorithm），这是使用它的发明人 John Nagle 的名字来命名的，John Nagle 在 1984 年首次用这个算法来尝试解决福特汽车公司的网络拥塞问题

问题的具体描述是：如果我们的应用程序一次产生 1 个字节的数据，而这个 1 个字节数据又以网络数据包的形式发送到远端服务器，那么就很容易导致网络由于太多的数据包而过载。比如，当用户使用 Telnet 连接到远程服务器时，每一次击键操作就会产生 1 个字节数据，进而发送出去一个数据包，所以，在典型情况下，传送一个只拥有 1 个字节有效数据的数据包，却要发费 40 个字节长包头（即 ip 头 20 字节 + tcp 头 20 字节）的额外开销，这种有效载荷（payload）利用率极其低下的情况被统称之为愚蠢窗口症候群（Silly Window Syndrome）。可以看到，这种情况对于轻负载的网络来说，可能还可以接受，但是对于重负载的网络而言，就极有可能承载不了而轻易的发生拥塞瘫痪。

针对上面提到的这个状况，Nagle 算法的改进在于：如果发送端欲多次发送包含少量字符的数据包，则发送端会先将第一个小包发送出去，而将后面到达的少量字符数据都缓存起来而不立即发送，直到收到接收端对前一个数据包报文段的 ACK 确认，或当前字符属于紧急数据，再或者是积攒到了一定数量的数据（Nagle 算法中规定：当到达的数据已达到发送窗口大小的一半或已达到报文段的最大长度时，就立即发送一个报文段）等多种情况才将其组成一个较大的数据包发送出去。

**注意：** Nagle 算法只有在收到对前一个报文段的确认后才继续发送下一个报文段。

Nagle 算法就是为了尽可能发送大块数据，避免网络中充斥着许多小数据块。

当数据到达较快而网络速率较慢时，用 Nagle 算法可以明显地减少所用的网络带宽。

**禁用Nagle算法：**

开启TCP_NODELAY选项，这个选项的作用就是禁用Nagle算法，禁止后当然就不会有它引起的一系列问题了。

使用setsockopt可以做到：

```cpp
static void _set_tcp_nodelay(int fd) {
	int enable = 1;
	setsockopt(fd, IPPROTO_TCP, TCP_NODELAY, (void*)&enable, sizeof(enable));
}
```